<!DOCTYPE html>
<html lang="fr">
<head>
    <title>CH VOTATIONS HISTO</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="http://d3js.org/d3.v5.js"></script>
    <style>

        .gen_title{
            margin-left: 70px;
            font: 500 45px "Times New Roman";
        }

        .custom-select{
            margin-left: 70px;
            width: 600px;
            font: 500 25px "Times New Roman";
        }

        .comment {
            margin-left: 70px;
        }

        text {
            font: 18px serif;
        }

        .dot {
            stroke: #000;
        }

        .axis path, .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .label {
            fill: #4f4f4f;
        }

        .nr_votation.label {
            font: 500 28px "Times New Roman";
            fill: #6e6e6e;
        }

        .nr_votation.label.active {
            fill: #ab4f54;
        }

        .overlay {
            fill: none;
            pointer-events: all;
            cursor: ew-resize;
        }

    </style>
</head>
<body id = "myPage">

<!-- Container général de l'application  -->
<div class = "anim">
    <h1 class="gen_title"> Historique des votations fédérales par canton</h1>

    <!-- Sélection des années et lancement de l'animation -->
    <div class="custom-select">
        de
        <select id = "y_start">
            <option value="0">2010</option>
            <option value="1">2000</option>
            <option value="2">1990</option>
            <option value="3">1980</option>
            <option value="4">1960</option>
            <option value="5">1940</option>
            <option value="6">1920</option>
            <option value="7">1900</option>
            <option value="8">1894</option>
        </select>
        à
        <select id = "y_end">
            <option value="0">2017</option>
            <option value="1">2010</option>
            <option value="2">2000</option>
            <option value="3">1990</option>
            <option value="4">1980</option>
            <option value="5">1960</option>
            <option value="6">1940</option>
            <option value="7">1920</option>
        </select>
        <button onclick="choice()">Lancer l'animation</button>
    </div>

    <!-- Mode d'emploi puis container pour l'annimation -->
    <div id="chart">
        <svg width = "1000" height = "600" >
            <image xlink:href="modeemploi2.png" width = "1000" height = "600" x = "0" y ="0" />
        </svg>
    </div>

    <!-- Commentaire d'aide toujours présent -->
    <div class="comment">
        Le rayon des bulles est proportionnel aux nombres de votants (sauf pour la Suisse).
        Pour faire défiler les votations >>> <strong>déplacer la souris sur les libellés</strong>
    </div>
</div>

<script>
    // Offre le choix de la période sous revue pour les votations
    function choice() {
        var range_start = [66,153,252,319,433,495,547,575,590],
            range_end = [0,66,153,252,319,433,495,547];

        var e1 = document.getElementById("y_start");
        var vot_start = range_start[+e1.options[e1.selectedIndex].value];
        var e2 = document.getElementById("y_end");
        var vot_end = range_end[+e2.options[e2.selectedIndex].value];

        if (document.querySelector('.graphics') !== null) {
            d3.selectAll("svg").remove();
        }
        d3.select("svg").remove();
        draw(vot_start,vot_end)
    }

    // Construit et remplit le graphique des votations
    function draw(v_start,v_stop) {

        // Fonctions pour afficher les 5 variables (ou dimensions) des votations à visualiser.
        function x(d) {
            return d["Participation en %"];
        }

        function y(d) {
            return d["Oui en %"];
        }

        function radius(d) {
            return d["Bulletins valables"];
        }

        function color(d) {
            return d["Région"];
        }

        function key(d) {
            return d["Canton"];
        }

        // Dimension du graphique
        var dim = document.getElementById("chart"),
            w = Math.max(window.innerWidth-100,900),
            h = Math.max(window.innerHeight-200,550),
            h2 = (h+6).toString() +"px",
            margin = {top: 19.5, right: 19.5, bottom: 59.5, left: 59.5},
            width = w - margin.right,
            height = h - margin.top - margin.bottom;

        dim.style.marginLeft = "-10px";
        dim.style.height = h2;

        // Fixe les échelles en fonction des données disponibles.
        var xScale = d3.scaleLinear()
            .domain([0, 100])
            .range([0, width]);

        var yScale = d3.scaleLinear()
            .domain([0, 100])
            .range([height, 0]);

        var radiusScale = d3.scaleSqrt()
            .domain([0, 500000])
            .range([0, 50]);

        var colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        // Fixe les échelles x et y
        var xAxis = d3.axisBottom()
            .scale(xScale)
            .ticks(10, d3.format(",d"));

        var yAxis = d3.axisLeft()
            .scale(yScale);

        // Crée les containers SVG et fixe l'origine.
        var svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("class", "graphics")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Ajoute l'axe x.
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        // Ajoute l'axe y.
        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        // Ajoute la légende de l'axe x.
        svg.append("text")
            .attr("class", "x_label")
            .attr("text-anchor", "end")
            .attr("x", width)
            .attr("y", height - 6)
            .text("Taux de participation en pourcent");

        // Ajoute la légende de l'axe y.
        svg.append("text")
            .attr("class", "y_label")
            .attr("text-anchor", "end")
            .attr("y", 6)
            .attr("dy", ".75em")
            .attr("transform", "rotate(-90)")
            .text("Taux d'acceptation en pourcent");

        // Ajoute la légende de la votation, celle-ci varie par transition.
        var label = svg.append("text")
            .attr("class", "nr_votation label")
            .attr("text-anchor", "end")
            .attr("y", height + 54)
            .attr("x", width)
            .text("SELECTION SOURIS : 24.09.2017 Réforme de la prévoyance vieillesse");

        // Ajoute une légende fixe pour la couleur des bulles
        svg.append("text")
            .attr("class", "legende_result")
            .attr("text-anchor", "end")
            .attr("y", 6)
            .attr("x", width)
            .attr("fill", "#000000")
            .text("Code couleur :");

        // Ajoute une légende fixe pour la couleur des bulles suisses
        svg.append("text")
            .attr("class", "result_CH")
            .attr("text-anchor", "end")
            .attr("y", 26)
            .attr("x", width)
            .attr("fill", "#cc0000")
            .text("Suisse entière");

        // Ajoute une légende fixe pour la couleur des bulles des cantons alémaniques
        svg.append("text")
            .attr("class", "result_SUI")
            .attr("text-anchor", "end")
            .attr("y", 46)
            .attr("x", width)
            .style("fill", "#4682B4")
            .text("Cantons alémaniques");

        // Ajoute une légende fixe pour la couleur des bulles des cantons romands
        svg.append("text")
            .attr("class", "result_SUI")
            .attr("text-anchor", "end")
            .attr("y", 66)
            .attr("x", width)
            .style("fill", "#FF8C00")
            .text("Cantons romands");

        // Ajoute une légende fixe pour la couleur des bulles du Tessin
        svg.append("text")
            .attr("class", "result_SUI")
            .attr("text-anchor", "end")
            .attr("y", 86)
            .attr("x", width)
            .style("fill", "#32CD32")
            .text("Canton italophone");

        // Ajoute une ligne de séparation horizontale à 50 %
        svg.append("line")
            .attr("class", "limit_50")
            .attr("x1", 0)
            .attr("x2", width)
            .attr("y1", height/2)
            .attr("y2", height/2)
            .style("stroke-dasharray",("3,3"))
            .style("stroke",'black');

        // Charge le fichier des données
        d3.json("essai7.json").then(function (donnees) {

            //arrangement des données par votations [{key : no votation  et values : [{les données},..]}, ..]
            var parvotation = d3.nest()
                .key(function (d) {
                    return d["Numéro"];
                })
                .entries(donnees);

            //parvotation contient 591 objets (votations) de 0 à 590
            //parvotation[590].values, longueur = le nombre de cantons, pour chaque canton les données
            //console.log(parvotation[590].values[0]["Oui en %"]); pour la dernière votation 2017, le premier canton, le taux de oui

            // Ajoute un point par votation et initialise les données à 2017 (votation 0).
            var dot = svg.append("g")
                .attr("class", "dots")
                .selectAll(".dot")
                .data(votationData(v_stop))
                .enter().append("circle")
                .attr("class", "dot")
                .style("fill", function (d) {
                    return colorScale(color(d));
                })
                .call(position)
                .sort(order);

            // Ajoute un titre sur les points
            dot.append("title")
                .text(function (d) {
                    return d["Canton"];
                });

            // Ajoute un overlay pour la légende de la votation
            var box = label.node().getBBox();

            var overlay = svg.append("rect")
                .attr("class", "overlay")
                .attr("x", box.x)
                .attr("y", box.y)
                .attr("width", box.width)
                .attr("height", box.height)
                .on("mouseover", enableInteraction);

            // Démarre une transition basée sur une interpolation du numéro des votations.
            svg.transition()
                .duration(30000)
                .ease(d3.easeLinear)
                .tween("nr_votation", tweenVotation)
                .on("end", enableInteraction);

            // Place les points selon les données.
            function position(dot) {
                dot.attr("cx", function (d) {
                    return xScale(x(d));
                })
                    .attr("cy", function (d) {
                        return yScale(y(d));
                    })
                    .attr("r", function (d) {
                        return radiusScale(radius(d));
                    });
            }

            // Pour que les petits points soient devant.
            function order(a, b) {
                return radius(b) - radius(a);
            }

            // Possibilité de passer avec la souris pour changer la votation.
            function enableInteraction() {
                var votScale = d3.scaleLinear()
                    .domain([v_start, v_stop])
                    .range([box.x + 10, box.x + box.width - 10])
                    .clamp(true);

                //Annule la transition si elle existe.
                svg.transition().duration(0);

                overlay
                    .on("mouseover", mouseover)
                    .on("mouseout", mouseout)
                    .on("mousemove", mousemove)
                    .on("touchmove", mousemove);

                function mouseover() {
                    label.classed("active", true);
                }

                function mouseout() {
                    label.classed("active", false);
                }

                function mousemove() {
                    displayVotation(votScale.invert(d3.mouse(this)[0]));
                }
            }

            // Animation de l'interpolation des votations.
            // Les points et légendes sont rechargés pour les données interpolées.
            function tweenVotation() {
                var nr_votation = d3.interpolateNumber(v_start, v_stop);
                return function (t) {
                    displayVotation(nr_votation(t));
                };
            }

            // Modifie le display avec la votation sélectionnée.
            function displayVotation(nr_votation) {
                var nr = Math.round(nr_votation);
                dot.data(votationData(nr), key).call(position).sort(order);
                label.text(votationData(nr)[0]["Libellé"]);
            }

            // Extraction des données de chaque votation.
            function votationData(nr) {
                return parvotation[nr].values;
            }

        });
    }

</script>
</body>
</html>